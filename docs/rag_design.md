# RAG系统设计文档

## 1. 系统概述

本系统是一个基于检索增强生成（Retrieval-Augmented Generation, RAG）的5G核心网资源智能管理系统，旨在通过结合文本和图结构信息，提供高效的资源检索和管理能力。系统采用双通道编码器架构，分别处理文本和图结构数据，并通过对比学习方法将两种模态的信息对齐。

## 2. 系统架构

### 2.1 整体架构

```
                                    ┌─────────────────┐
                                    │     用户查询     │
                                    └────────┬────────┘
                                             │
                                    ┌────────▼────────┐
                                    │   查询处理模块    │
                                    └────────┬────────┘
                                             │
                     ┌───────────────────────┴───────────────────────┐
                     │                                               │
             ┌───────▼───────┐                             ┌────────▼────────┐
             │  文本编码通道   │                             │   图编码通道     │
             └───────┬───────┘                             └────────┬────────┘
                     │                                              │
             ┌───────▼───────┐                             ┌────────▼────────┐
             │   BERT 编码    │                             │    GAT 编码     │
             └───────┬───────┘                             └────────┬────────┘
                     │                                              │
                     └──────────────────┬───────────────────────────┘
                                       │
                              ┌────────▼────────┐
                              │    混合索引      │
                              └────────┬────────┘
                                       │
                              ┌────────▼────────┐
                              │   Neo4j 数据库   │
                              └─────────────────┘
```

### 2.2 核心组件

系统主要由以下几个核心组件构成：

1. **特征提取器（FeatureExtractor）**：负责从原始数据中提取特征，包括文本特征和图结构特征。
2. **双通道编码器（DualEncoder）**：包含文本编码器和图编码器，分别处理文本和图结构数据，并将它们映射到同一语义空间。
3. **混合索引（HybridIndex）**：存储和管理编码后的特征向量，支持高效的相似度检索。
4. **查询处理器（QueryProcessor）**：处理用户查询，通过检索相关信息并结合LLM生成响应。

## 3. 目录结构

```
kk_GraphAgent/
├── configs/                  # 配置文件目录
│   └── train_config.yaml     # 训练配置文件
├── data/                     # 数据目录
├── docs/                     # 文档目录
│   ├── rag_design.md         # RAG系统设计文档
│   ├── progress.md           # 项目进度报告
│   └── work_log.md           # 工作日志
├── rag/                      # RAG系统核心代码
│   ├── data/                 # 数据处理模块
│   │   └── graph_text_dataset.py  # 图文对数据集
│   ├── models/               # 模型定义
│   │   ├── dual_encoder.py   # 双通道编码器模型
│   │   └── loss.py           # 损失函数定义
│   ├── scripts/              # 脚本目录
│   │   └── train.py          # 训练脚本
│   ├── training/             # 训练相关代码
│   │   └── trainer.py        # 训练器
│   ├── utils/                # 工具函数
│   │   ├── logging.py        # 日志工具
│   │   ├── metrics.py        # 评估指标
│   │   └── tools.py          # 通用工具
│   ├── encoder.py            # 编码器接口
│   ├── feature_extractor.py  # 特征提取器
│   ├── indexer.py            # 索引管理器
│   ├── query_processor.py    # 查询处理器
│   └── trainer.py            # 顶层训练器
├── results/                  # 结果目录
├── scripts/                  # 脚本目录
│   ├── test_loss_functions.py  # 损失函数测试脚本
│   └── test_text_encoder.py    # 文本编码器测试脚本
├── test_results/             # 测试结果目录
└── utils/                    # 通用工具
    └── logger.py             # 日志工具
```

## 4. 核心组件详解

### 4.1 特征提取器（FeatureExtractor）

特征提取器负责从原始数据中提取特征，包括：
- 文本特征提取：使用预训练的中文BERT模型提取文本特征
- 图结构特征提取：使用图神经网络提取图结构特征
- 节点静态特征提取：提取节点的静态属性特征
- 节点动态特征提取：提取节点的时序动态特征
- 关系特征提取：提取边的类型和属性特征
- 子图特征提取：提取局部子图的结构特征

**相关文件**：`rag/feature_extractor.py`

### 4.2 双通道编码器（DualEncoder）

双通道编码器包含两个子编码器：

#### 4.2.1 文本编码器
- 基于预训练的中文BERT模型
- 支持多种池化策略（CLS、平均池化、最大池化、注意力池化、加权池化）
- 实现了层权重学习机制，支持不同层表示的加权组合
- 可配置的输出维度和dropout
- 可选的模型参数冻结

#### 4.2.2 图编码器
- 基于动态异构图神经网络
- 实现了节点级注意力层（NodeLevelAttention）
- 实现了边级注意力层（EdgeLevelAttention）
- 实现了时间序列编码器（TimeSeriesEncoder）
- 实现了时间级注意力层（TemporalLevelAttention）
- 实现了层级感知模块（HierarchicalAwarenessModule）
- 支持多层注意力机制
- 支持边特征融合
- 实现了残差连接和层归一化
- 可配置的注意力头数和隐藏维度

#### 4.2.3 双通道集成
- 文本和图特征对齐
- 投影层用于特征转换
- 余弦相似度计算
- 批处理支持

**相关文件**：
- `rag/models/dual_encoder.py`：双通道编码器模型定义
- `rag/encoder.py`：编码器接口定义

### 4.3 损失函数（Loss Functions）

系统实现了多种损失函数，用于训练双通道编码器：
- 对比损失（ContrastiveLoss）：基础的对比学习损失
- InfoNCE损失（InfoNCELoss）：基于噪声对比估计的损失
- 三元组损失（TripletLoss）：基于三元组的损失
- 批量对比损失（BatchContrastiveLoss）：支持批量内对比和硬负样本
- 多正样本损失（MultiPositiveLoss）：支持多个正样本的对比损失
- 硬负样本挖掘损失（HardNegativeMiningLoss）：支持在线硬负样本挖掘
- 组合损失（CombinedLoss）：结合对比损失和三元组损失

**相关文件**：`rag/models/loss.py`

### 4.4 数据处理（Data Processing）

数据处理模块负责加载和处理训练数据：

#### 4.4.1 数据集设计
```python
class GraphTextDataset:
    def __init__(self):
        # 初始化数据集
        self.nodes = []  # 节点列表
        self.edges = []  # 边列表
        self.text_descriptions = {}  # 文本描述字典
        
    def _load_graph_data(self):
        # 从Neo4j加载图数据
        pass
        
    def _generate_text_descriptions(self):
        # 生成节点文本描述
        pass
        
    def _create_pairs(self):
        # 创建图文对
        pass
```

#### 4.4.2 数据预处理
- 节点特征提取和归一化
- 边特征提取和归一化
- 文本标记化和截断
- 子图采样和批处理

#### 4.4.3 数据增强
- 随机掩码
- 子图采样
- 文本重写
- 对比学习样本构造

**相关文件**：`rag/data/graph_text_dataset.py`

### 4.5 训练器（Trainer）

训练器负责模型的训练和评估：
- 支持多种损失函数
- 支持AdamW优化器
- 支持余弦学习率调度
- 支持梯度裁剪
- 支持早停和检查点保存
- 支持训练过程可视化

**相关文件**：
- `rag/training/trainer.py`：训练器实现
- `rag/scripts/train.py`：训练脚本

### 4.6 评估指标（Metrics）

系统实现了多种评估指标，用于评估模型性能：

#### 4.6.1 检索指标
- Hits@K (K=1,5,10)
- MRR@K
- Precision@K
- Recall@K
- NDCG@K

#### 4.6.2 语义相似度指标
- 余弦相似度
- 语义对齐准确率
- 特征空间分布

#### 4.6.3 效率指标
- 查询延迟
- 内存使用
- 吞吐量

**相关文件**：`rag/utils/metrics.py`

### 4.7 索引管理器（Indexer）

索引管理器负责存储和管理编码后的特征向量：
- 支持向量存储和检索
- 支持FAISS索引
- 支持多种索引策略
- 支持增量更新

**相关文件**：`rag/indexer.py`

### 4.8 查询处理器（QueryProcessor）

查询处理器负责处理用户查询：
- 查询理解：分析用户查询意图
- 检索增强：检索相关信息
- 响应生成：结合检索结果生成响应

**相关文件**：`rag/query_processor.py`

## 5. 配置管理

### 5.1 模型配置
```yaml
model:
  text_model_name: "bert-base-chinese"
  node_dim: 256
  edge_dim: 64
  hidden_dim: 256
  output_dim: 768
  num_heads: 8
  dropout: 0.1
```

### 5.2 训练配置
```yaml
training:
  batch_size: 32
  num_epochs: 100
  learning_rate: 1e-4
  weight_decay: 1e-5
  warmup_steps: 1000
  max_grad_norm: 1.0
```

### 5.3 数据配置
```yaml
data:
  max_text_length: 512
  max_node_size: 100
  max_edge_size: 200
  train_ratio: 0.8
  val_ratio: 0.1
  test_ratio: 0.1
```

## 6. 训练流程

系统的训练流程如下：

1. **数据准备**：从Neo4j数据库加载图数据，生成对应的文本描述，构建图文对数据集
2. **模型初始化**：初始化双通道编码器，包括文本编码器和图编码器
3. **损失函数选择**：根据配置选择合适的损失函数
4. **训练循环**：
   - 数据加载和批处理
   - 前向传播：计算文本和图的嵌入向量
   - 损失计算：计算损失值
   - 反向传播：更新模型参数
   - 验证评估：计算验证集上的性能指标
5. **模型保存**：保存训练好的模型和检查点

## 7. 推理流程

系统的推理流程如下：

1. **查询处理**：处理用户查询，提取关键信息
2. **特征提取**：使用文本编码器提取查询的特征向量
3. **检索**：在索引中检索相似的图结构
4. **响应生成**：结合检索结果生成响应

## 8. 当前进度

根据项目进度报告，当前各模块的完成情况如下：

| 模块 | 完成度 | 状态 |
|------|-------|------|
| 特征提取器 | 90% | 基本完成，待优化性能 |
| 双通道编码器 | 70% | 文本编码器和图编码器已实现，待完成时序特征处理和优化 |
| 损失函数 | 100% | 已完成所有设计的损失函数实现和测试 |
| 训练流程 | 90% | 基本完成，待实现分布式训练支持 |
| 索引系统 | 30% | 已设计接口和实现向量存储，待实现FAISS索引和混合索引 |
| 查询处理器 | 20% | 已设计接口，待实现查询理解和检索增强 |
| 系统集成 | 10% | 已设计系统架构，待实现组件通信和错误处理 |
| 性能优化 | 0% | 尚未开始 |

## 9. 下一步计划

### 9.1 LLM集成
- 选择合适的LLM模型
- 设计提示工程策略
- 实现查询意图识别
- 开发Cypher查询生成器

### 9.2 Agent系统
- 设计Agent架构
- 实现任务规划
- 开发工具调用接口
- 集成对话管理

### 9.3 其他工作
- 完成数据集的扩展和增强功能
- 开始训练双通道编码器模型
- 实现检索评估脚本，评估模型的检索性能
- 开发索引构建和查询处理功能

## 10. 未来工作

1. **多模态扩展**：支持更多模态的数据，如图像、音频等
2. **交互式学习**：支持用户反馈，不断优化模型性能
3. **分布式部署**：支持大规模分布式部署，提高系统吞吐量
4. **知识图谱集成**：深度集成知识图谱，提高系统的知识理解能力